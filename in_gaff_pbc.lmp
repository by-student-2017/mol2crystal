#---------------------------------------------
# user setting
variable Pinit   equal  1.0     # 0.1 MPa ( 1.0 bar = 0.1 MPa)
variable Pobject equal 10.0     # 1.0 MPa (10.0 bar = 1.0 MPa)
variable Tinit   equal 273-269  # [K] (e.g., He 4 [K])
variable Tobject equal 273+25   # [K] (e.g., Room temperature 298 [K])
#---------------------------------------------

include   'system.in.init'
read_data 'system.data'
include   'system.in.settings'

replicate 1 1 1

# Stabilize communication and connections (optional)
comm_modify cutoff 20.0
special_bonds lj/coul 0 0 1

# output data
thermo 100
thermo_style custom step etotal temp lx ly lz vol press vol density

# Energy minimization
fix boxrelax all box/relax aniso 0.0
minimize 1.0e-5 1.0e-7 1000 10000
unfix boxrelax

# Initial temperature setting at Tinit [K]
#velocity all create ${Tinit} 4928459 dist gaussian
velocity all set 0.0 0.0 0.0 # To prevent molecular breakdown

# 1.0 fs step (Typical values ​​for GAFF, LJ, etc.)
timestep 0.25

# Initial easing with NVT
fix fxnvt all nvt temp ${Tinit} ${Tobject} 500.0 tchain 1
run 20000 # 5 ps

write_data md_nvt.data

run 0
variable  natoms equal "count(all)" 
variable      x0 equal "lx"
variable      y0 equal "ly"
variable      z0 equal "lz"
variable      v0 equal "vol"
variable   etot0 equal "etotal"
variable   ecoh0 equal "pe/v_natoms"

variable mass_total equal mass(all)
variable density equal ${mass_total}/(0.6022*${v0})  # g/cm^3

print "-------------------------------------------------------------"
print "Show results of 1st step (Running Minimization)"
print "The number of atoms = ${natoms}"
print "The lattice constant, x (Angstoms) = ${x0}"
print "The lattice constant, y (Angstoms) = ${y0}"
print "The lattice constant, z (Angstoms) = ${z0}"
print "The volume (Angstoms^3) = ${v0}"
print "The total energy (kcal/mol) = ${etot0}"
print "The cohesive energy (kcal/mol) = ${ecoh0}"
print "The density (g/cm^3) = ${density}"
print "-------------------------------------------------------------"
print "NVT: Simulations completed !"

reset_timestep 0
# 1.0 fs step (Typical values ​​for GAFF, LJ, etc.)
timestep 1.0

# Volume relaxation with NPT
# -------------------------------------------------------------
# drag is a damping coefficient that slows down the rate at which the box size changes.
# Smaller values ​​result in slower changes, while larger values ​​result in more rapid changes.
# 0.2 provides moderate damping (recommended value) for a good balance between stability and responsiveness.
# -------------------------------------------------------------
unfix fxnvt
fix fxnpt1 all npt temp ${Tinit} ${Tobject}   $(100.0*dt)  aniso ${Pinit} ${Pobject} $(2000.0*dt) drag 0.2
run 20000 # 20 ps

unfix fxnpt1
fix fxnpt2 all npt temp ${Tobject} ${Tobject} $(100.0*dt)  aniso ${Pobject} ${Pinit} $(2000.0*dt)  drag 0.2
run 20000 # 20 ps

-------------------------------------------------------------
#dump 1 all dcd 100 md_npt.dcd
#dump_modify 1 unwrap yes
-------------------------------------------------------------

write_data md_npt.data

run 0
variable  natoms equal "count(all)" 
variable      x0 equal "lx"
variable      y0 equal "ly"
variable      z0 equal "lz"
variable      v0 equal "vol"
variable   etot0 equal "etotal"
variable   ecoh0 equal "pe/v_natoms"

variable mass_total equal mass(all)
variable density equal ${mass_total}/(0.6022*${v0})  # g/cm^3

print "-------------------------------------------------------------"
print "Show results of 1st step (Running Minimization)"
print "The number of atoms = ${natoms}"
print "The lattice constant, x (Angstoms) = ${x0}"
print "The lattice constant, y (Angstoms) = ${y0}"
print "The lattice constant, z (Angstoms) = ${z0}"
print "The volume (Angstoms^3) = ${v0}"
print "The total energy (kcal/mol) = ${etot0}"
print "The cohesive energy (kcal/mol) = ${ecoh0}"
print "The density (g/cm^3) = ${density}"
print "-------------------------------------------------------------"
print "NPT: Simulations completed !"
